# DR-002: SPA遷移時に字幕パネルを閉じて開き直す

- **日付**: 2026-02-28
- **ステータス**: 採用

## 背景

同じタブ上で別の動画に遷移した後に拡張機能を使用すると、前の動画のサマリ情報（タイトル・字幕セグメント等）が表示される不具合が発生した。

## 原因

YouTubeはSPA (Single Page Application) であり、動画間の遷移でページのフルリロードが発生しない。そのため以下の問題が生じていた:

1. **字幕パネルが前の動画のまま残る** — パネルが「既に開いている」と判断され、前の動画のセグメントがそのままスクレイピングされる
2. **`og:title`等のメタタグが未更新** — SPA遷移直後はDOMが前の動画の状態のまま
3. **`ytInitialPlayerResponse`が古い** — 初回ロード時の値が残る可能性

根本原因は、動画が変わったことを検知してパネルをリセットする仕組みがなかったこと。

## 選択肢

1. **常にパネルを閉じて開き直す** — 確実だが毎回パネル開閉のオーバーヘッドが発生
2. **videoIdを比較して変更時のみリセット** — 効率的だが、パネル内にvideoIdの紐付け情報がなく判定が困難
3. **yt-navigate-finishイベントを監視して事前リセット** — 理想的だがイベント発火タイミングの信頼性に不安

## 決定

**選択肢1: 常にパネルを閉じて開き直す**

## 理由

- 確実性が最も高く、実装がシンプル
- パネル開閉は約2秒程度の追加待機で済み、ユーザー体験への影響は軽微
- 字幕取得は頻繁に行う操作ではないため、オーバーヘッドは許容範囲

## 変更ファイル

- `extension/background.js` — `injectedGetTranscriptInfo()` のパネル開閉ロジック
- `extension/content.js` — `openTranscriptPanel()` のパネル開閉ロジック
